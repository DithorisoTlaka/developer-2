<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lumina — Your Learning Space</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet"/>

  <style>
    :root {
      --bg:          #0a0e17;
      --surface:     #11151f;
      --text:        #e5e7eb;
      --text-muted:  #9ca3af;
      --border:      #1f2937;
      --primary:     #6366f1;
      --primary-dark:#4f46e5;
      --glow:        rgba(99, 102, 241, 0.18);
      --error:       #f87171;
      --success:     #34d399;
      --sidebar-collapsed: 72px;
      --sidebar-expanded: 260px;
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* ── AUTH PAGE ─────────────────────────────────────── */
    #authPage {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 1.5rem;
    }

    .auth-container {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 2.5rem 2rem;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
    }

    .logo { font-size: 2.4rem; font-weight: 600; letter-spacing: -0.04em; text-align: center; margin-bottom: 0.5rem; color: white; }
    .subtitle { text-align: center; color: var(--text-muted); font-size: 0.95rem; margin-bottom: 2.2rem; }

    .tabs { display: flex; margin-bottom: 1.8rem; border-bottom: 1px solid var(--border); }
    .tab { flex: 1; background: none; border: none; padding: 0.9rem 0; font-size: 0.97rem; color: var(--text-muted); cursor: pointer; font-weight: 500; transition: color 0.2s; position: relative; }
    .tab.active { color: white; }
    .tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background: var(--primary); }

    .form-field { margin-bottom: 1.4rem; }
    label { display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem; font-weight: 500; }
    input { width: 100%; padding: 0.9rem 1.1rem; background: #0f1622; border: 1px solid var(--border); border-radius: 8px; color: white; font-size: 0.97rem; transition: border-color 0.2s, box-shadow 0.2s; }
    input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--glow); }

    .btn { width: 100%; padding: 1rem; margin: 0.6rem 0; border: none; border-radius: 9999px; font-size: 0.97rem; font-weight: 500; cursor: pointer; transition: all 0.2s; position: relative; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-google { background: #ffffff; color: #111827; display: flex; align-items: center; justify-content: center; gap: 0.7rem; }
    .btn-google:hover { background: #f3f4f6; }

    .btn-loading::after { content: ""; display: inline-block; width: 16px; height: 16px; border: 2px solid white; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; margin-left: 8px; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .divider { display: flex; align-items: center; text-align: center; margin: 1.6rem 0; color: var(--text-muted); font-size: 0.85rem; }
    .divider::before, .divider::after { content: ''; flex: 1; border-bottom: 1px solid var(--border); }
    .divider span { padding: 0 1.2rem; }

    .toggle { text-align: center; margin-top: 1.2rem; color: var(--text-muted); font-size: 0.92rem; }
    .toggle a { color: var(--primary); text-decoration: none; font-weight: 500; }
    .toggle a:hover { text-decoration: underline; }

    .error-msg { color: var(--error); font-size: 0.85rem; margin: 0.8rem 0; text-align: center; }

    /* ── DASHBOARD ─────────────────────────────────────── */
    #dashboard { display: none; }

    .dashboard-wrapper { display: flex; min-height: 100vh; }

    .sidebar-left {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: var(--sidebar-collapsed);
      background: var(--surface);
      border-right: 1px solid var(--border);
      transition: width 0.35s ease;
      overflow: hidden;
      z-index: 100;
    }

    .sidebar-left:hover {
      width: var(--sidebar-expanded);
    }

    .sidebar-content {
      padding: 5rem 0 2rem;
    }

    .tab-link {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem 1.8rem;
      color: var(--text-muted);
      text-decoration: none;
      font-weight: 500;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .tab-link:hover,
    .tab-link.active {
      background: rgba(99,102,241,0.12);
      color: white;
    }

    .tab-link .icon { font-size: 1.4rem; min-width: 24px; text-align: center; }

    .main-view {
      margin-left: var(--sidebar-collapsed);
      flex: 1;
      padding: 2.5rem;
      transition: margin-left 0.35s ease;
    }

    .sidebar-left:hover ~ .main-view {
      margin-left: var(--sidebar-expanded);
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .welcome { font-size: 1.9rem; font-weight: 600; }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.8rem;
      margin-bottom: 2rem;
    }

    .card h2 { margin-bottom: 1rem; color: var(--primary); }

    .assignment-item {
      padding: 1rem 0;
      border-bottom: 1px solid var(--border);
    }

    .assignment-item:last-child { border-bottom: none; }

    .assignment-title { font-weight: 500; margin-bottom: 0.3rem; }
    .assignment-due { color: var(--error); font-size: 0.9rem; }

    .empty-state {
      text-align: center;
      color: var(--text-muted);
      padding: 4rem 1rem;
      font-size: 1.1rem;
    }

    @media (max-width: 900px) {
      .sidebar-left { width: var(--sidebar-collapsed); }
      .sidebar-left:hover { width: var(--sidebar-expanded); }
      .main-view { margin-left: var(--sidebar-collapsed); }
      .sidebar-left:hover ~ .main-view { margin-left: var(--sidebar-expanded); }
    }
  </style>
</head>
<body>

  <!-- AUTH PAGE -->
  <div id="authPage">
    <div class="auth-container">
      <div class="logo">Lumina</div>
      <div class="subtitle">Your learning space</div>

      <div class="tabs">
        <button class="tab active" onclick="switchMode('login')">Sign in</button>
        <button class="tab" onclick="switchMode('signup')">Create account</button>
      </div>

      <div id="errorMessage" class="error-msg"></div>

      <!-- Sign In -->
      <form id="loginForm">
        <div class="form-field">
          <label for="loginEmail">Email</label>
          <input type="email" id="loginEmail" placeholder="you@example.com" required autocomplete="email" />
        </div>
        <div class="form-field">
          <label for="loginPassword">Password</label>
          <input type="password" id="loginPassword" placeholder="••••••••" required autocomplete="current-password" />
        </div>

        <button type="submit" class="btn btn-primary" id="loginBtn">Sign in</button>

        <div class="divider"><span>or</span></div>

        <button type="button" class="btn btn-google" id="googleLoginBtn" onclick="signInWithGoogle()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M22.56 12.25C22.56 11.47 22.49 10.69 22.36 10H12V14.51H18.2C17.95 15.99 17.05 17.23 15.79 18.09V21.09H19.33C21.49 19.09 22.56 15.92 22.56 12.25Z" fill="#4285F4"/>
            <path d="M12 23C14.97 23 17.46 22 19.33 20.09L15.79 18.09C14.79 18.81 13.49 19.25 12 19.25C9.07 19.25 6.57 17.22 5.68 14.47H2.06V17.6C3.98 20.92 7.78 23 12 23Z" fill="#34A853"/>
            <path d="M5.68 14.47C5.25 13.17 5 11.61 5 10C5 8.39 5.25 6.83 5.68 5.53V2.4H2.06C0.72 5.09 0 8 0 11C0 13.99 0.72 16.91 2.06 19.6L5.68 14.47Z" fill="#FBBC05"/>
            <path d="M12 4.98C13.64 4.98 15.11 5.54 16.27 6.64L19.46 3.45C17.46 1.59 14.97 0.5 12 0.5C7.78 0.5 3.98 2.58 2.06 5.9L5.68 10C6.57 7.25 9.07 5.22 12 5.22V4.98Z" fill="#EA4335"/>
          </svg>
          Continue with Google
        </button>
      </form>

      <!-- Sign Up -->
      <form id="signupForm" style="display:none;">
        <div class="form-field">
          <label for="signupEmail">Email</label>
          <input type="email" id="signupEmail" placeholder="you@example.com" required autocomplete="email" />
        </div>
        <div class="form-field">
          <label for="signupPassword">Password</label>
          <input type="password" id="signupPassword" placeholder="••••••••" required minlength="6" autocomplete="new-password" />
        </div>
        <div class="form-field">
          <label for="signupConfirm">Confirm Password</label>
          <input type="password" id="signupConfirm" placeholder="••••••••" required minlength="6" autocomplete="new-password" />
        </div>

        <button type="submit" class="btn btn-primary" id="signupBtn">Create account</button>

        <div class="divider"><span>or</span></div>

        <button type="button" class="btn btn-google" id="googleSignupBtn" onclick="signInWithGoogle()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M22.56 12.25C22.56 11.47 22.49 10.69 22.36 10H12V14.51H18.2C17.95 15.99 17.05 17.23 15.79 18.09V21.09H19.33C21.49 19.09 22.56 15.92 22.56 12.25Z" fill="#4285F4"/>
            <path d="M12 23C14.97 23 17.46 22 19.33 20.09L15.79 18.09C14.79 18.81 13.49 19.25 12 19.25C9.07 19.25 6.57 17.22 5.68 14.47H2.06V17.6C3.98 20.92 7.78 23 12 23Z" fill="#34A853"/>
            <path d="M5.68 14.47C5.25 13.17 5 11.61 5 10C5 8.39 5.25 6.83 5.68 5.53V2.4H2.06C0.72 5.09 0 8 0 11C0 13.99 0.72 16.91 2.06 19.6L5.68 14.47Z" fill="#FBBC05"/>
            <path d="M12 4.98C13.64 4.98 15.11 5.54 16.27 6.64L19.46 3.45C17.46 1.59 14.97 0.5 12 0.5C7.78 0.5 3.98 2.58 2.06 5.9L5.68 10C6.57 7.25 9.07 5.22 12 5.22V4.98Z" fill="#EA4335"/>
          </svg>
          Continue with Google
        </button>
      </form>

      <div class="toggle" id="toggleSignup">
        Don't have an account? <a href="#" onclick="switchMode('signup'); return false;">Sign up</a>
      </div>
      <div class="toggle" id="toggleLogin" style="display:none;">
        Already have an account? <a href="#" onclick="switchMode('login'); return false;">Sign in</a>
      </div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard">
    <div class="dashboard-wrapper">
      <aside class="sidebar-left" id="sidebar">
        <div class="sidebar-content">
          <a href="#" class="tab-link active" data-tab="overview" onclick="showTab(event, 'overview')">
            <i class="ri-dashboard-line icon"></i> Overview
          </a>
          <a href="#" class="tab-link" data-tab="assignments" onclick="showTab(event, 'assignments')">
            <i class="ri-task-line icon"></i> Assignments
          </a>
          <a href="#" class="tab-link" data-tab="materials" onclick="showTab(event, 'materials')">
            <i class="ri-book-2-line icon"></i> Materials
          </a>
          <a href="#" class="tab-link" data-tab="timetable" onclick="showTab(event, 'timetable')">
            <i class="ri-calendar-schedule-line icon"></i> Timetable
          </a>
          <a href="#" class="tab-link" data-tab="chat" onclick="showTab(event, 'chat')">
            <i class="ri-chat-3-line icon"></i> Lecturer Chat
          </a>
        </div>
      </aside>

      <main class="main-view">
        <div class="dashboard-header">
          <div class="welcome">Welcome back, <span id="userDisplayName">Learner</span></div>
          <button class="btn btn-primary" onclick="signOutUser()">Sign Out</button>
        </div>

        <div id="overview" class="tab-content" style="display:block;">
          <div class="card">
            <h2>Dashboard Overview</h2>
            <p>Your account is active. You can now access assignments, materials, timetable and chat.</p>
          </div>
        </div>

        <div id="assignments" class="tab-content" style="display:none;">
          <div class="card">
            <h2>Assignments</h2>
            <div id="assignmentsList"></div>
          </div>
        </div>

        <div id="materials" class="tab-content" style="display:none;">
          <div class="card">
            <h2>Learning Materials</h2>
            <p>Study resources will be visible here.</p>
          </div>
        </div>

        <div id="timetable" class="tab-content" style="display:none;">
          <div class="card">
            <h2>Timetable</h2>
            <p>Class and exam schedule.</p>
          </div>
        </div>

        <div id="chat" class="tab-content" style="display:none;">
          <div class="card">
            <h2>Lecturer Chat</h2>
            <p>Communication with lecturers.</p>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Firebase + Realtime Database + Firestore logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

    import {
      getFirestore,
      doc,
      getDoc,
      setDoc
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    import {
      getDatabase,
      ref,
      onValue,
      set
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDLvkRwSpd-hbPaDP31pV1H-4N5_Re-_xc",
      authDomain: "learnermanagementsystem-f3b6a.firebaseapp.com",
      databaseURL: "https://learnermanagementsystem-f3b6a-default-rtdb.firebaseio.com",
      projectId: "learnermanagementsystem-f3b6a",
      storageBucket: "learnermanagementsystem-f3b6a.firebasestorage.app",
      messagingSenderId: "173549259244",
      appId: "1:173549259244:web:f8722018a989c484a7d8c9",
      measurementId: "G-K1VW244B7P"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const firestore = getFirestore(app);
    const database = getDatabase(app);
    const googleProvider = new GoogleAuthProvider();

    async function isStudentAllowed(email) {
      if (!email) return false;
      const normalized = email.toLowerCase().trim();
      const docRef = doc(firestore, "allowed_students", normalized);
      const docSnap = await getDoc(docRef);
      return docSnap.exists();
    }

    function setButtonLoading(btn, isLoading) {
      if (isLoading) {
        btn.disabled = true;
        btn.classList.add('btn-loading');
        const originalText = btn.innerHTML;
        btn.dataset.originalText = originalText;
        btn.innerHTML = 'Checking...';
      } else {
        btn.disabled = false;
        btn.classList.remove('btn-loading');
        if (btn.dataset.originalText) {
          btn.innerHTML = btn.dataset.originalText;
        }
      }
    }

    // Save user basic info to Realtime Database once after login/signup
    async function saveUserToDatabase(user) {
      if (!user) return;
      const userRef = ref(database, `users/${user.uid}`);
      const name = user.displayName || user.email?.split('@')[0] || 'Learner';

      // Only set if not already exists (to avoid overwriting)
      onValue(userRef, (snapshot) => {
        if (!snapshot.exists()) {
          set(userRef, {
            uid: user.uid,
            email: user.email,
            displayName: name,
            createdAt: new Date().toISOString()
          });
        }
      }, { onlyOnce: true });
    }

    // ── UI Switching ─────────────────────────────────────────────
    function showAuth() {
      document.getElementById('authPage').style.display = 'flex';
      document.getElementById('dashboard').style.display = 'none';
    }

    function showDashboard(user) {
      document.getElementById('authPage').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';

      const name = user.displayName || user.email?.split('@')[0] || 'Learner';
      document.getElementById('userDisplayName').textContent = name;

      // Save user info to RTDB
      saveUserToDatabase(user);
    }

    onAuthStateChanged(auth, (user) => {
      if (user) {
        showDashboard(user);
      } else {
        showAuth();
      }
    });

    // ── Tab Navigation ───────────────────────────────────────────
    window.showTab = function(e, tabId) {
      e.preventDefault();
      document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
      document.querySelectorAll('.tab-link').forEach(el => el.classList.remove('active'));

      document.getElementById(tabId).style.display = 'block';
      e.currentTarget.classList.add('active');
    };

    // ── Form Handlers ────────────────────────────────────────────
    document.getElementById('loginForm').addEventListener('submit', async e => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      const errorEl = document.getElementById('errorMessage');
      const btn = document.getElementById('loginBtn');

      errorEl.textContent = '';
      setButtonLoading(btn, true);

      const allowed = await isStudentAllowed(email);
      if (!allowed) {
        errorEl.textContent = 'Your account has not been registered by an administrator or lecturer.';
        setButtonLoading(btn, false);
        return;
      }

      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        errorEl.textContent =
          err.code === 'auth/wrong-password' ? 'Incorrect password' :
          err.code === 'auth/user-not-found' ? 'Account not found' :
          'Login failed. Please try again.';
      } finally {
        setButtonLoading(btn, false);
      }
    });

    document.getElementById('signupForm').addEventListener('submit', async e => {
      e.preventDefault();
      const email = document.getElementById('signupEmail').value.trim();
      const password = document.getElementById('signupPassword').value;
      const confirm = document.getElementById('signupConfirm').value;
      const errorEl = document.getElementById('errorMessage');
      const btn = document.getElementById('signupBtn');

      errorEl.textContent = '';

      if (password !== confirm) {
        errorEl.textContent = 'Passwords do not match';
        return;
      }

      if (password.length < 6) {
        errorEl.textContent = 'Password must be at least 6 characters';
        return;
      }

      setButtonLoading(btn, true);

      const allowed = await isStudentAllowed(email);
      if (!allowed) {
        errorEl.textContent = 'This email has not been pre-registered by an administrator or lecturer.';
        setButtonLoading(btn, false);
        return;
      }

      try {
        await createUserWithEmailAndPassword(auth, email, password);
      } catch (err) {
        errorEl.textContent =
          err.code === 'auth/email-already-in-use' ? 'This email is already registered' :
          err.code === 'auth/weak-password' ? 'Password is too weak' :
          'Sign up failed. Please try again.';
      } finally {
        setButtonLoading(btn, false);
      }
    });

    window.signInWithGoogle = async () => {
      const errorEl = document.getElementById('errorMessage');
      const btnLogin = document.getElementById('googleLoginBtn');
      const btnSignup = document.getElementById('googleSignupBtn');

      errorEl.textContent = 'Checking registration...';
      setButtonLoading(btnLogin, true);
      setButtonLoading(btnSignup, true);

      try {
        const result = await signInWithPopup(auth, googleProvider);
        const email = result.user.email;

        const allowed = await isStudentAllowed(email);
        if (!allowed) {
          await signOut(auth);
          errorEl.textContent = 'Your Google account has not been pre-registered by an administrator or lecturer.';
          return;
        }
      } catch (err) {
        errorEl.textContent = 'Google sign-in failed or account not pre-registered.';
      } finally {
        setButtonLoading(btnLogin, false);
        setButtonLoading(btnSignup, false);
      }
    };

    window.signOutUser = () => signOut(auth);

    window.switchMode = function(mode) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById('errorMessage').textContent = '';

      if (mode === 'login') {
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('signupForm').style.display = 'none';
        document.querySelector('.tab:first-child').classList.add('active');
        document.getElementById('toggleSignup').style.display = 'block';
        document.getElementById('toggleLogin').style.display = 'none';
      } else {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('signupForm').style.display = 'block';
        document.querySelector('.tab:last-child').classList.add('active');
        document.getElementById('toggleSignup').style.display = 'none';
        document.getElementById('toggleLogin').style.display = 'block';
      }
    };
  </script>
</body>
</html>
